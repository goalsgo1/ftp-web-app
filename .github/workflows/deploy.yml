name: Deploy to Production Server

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # GitHubì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: ğŸ” SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # ì„œë²„ í˜¸ìŠ¤íŠ¸ í‚¤ í™•ì¸ì„ ìœ„í•´ known_hostsì— ì¶”ê°€
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
      
      - name: âœ… SSH ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "echo 'SSH ì—°ê²° ì„±ê³µ!'"
      
      - name: ğŸš€ ì„œë²„ ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ~/.ssh/deploy_key
          script: |
            cd /var/www/myapp
            ./deploy.sh
            
      - name: âœ… ë°°í¬ ìƒíƒœ í™•ì¸
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ~/.ssh/deploy_key
          script: |
            echo "=== ë°°í¬ ìƒíƒœ í™•ì¸ ==="
            ls -la /var/www/myapp/current/public/ | head -10
            echo ""
            echo "=== ìµœì‹  ë¦´ë¦¬ì¦ˆ ==="
            ls -lt /var/www/myapp/releases/ | head -5
      
      - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“ ì„œë²„: ${{ secrets.DEPLOY_HOST }}"
          echo "ğŸ“ ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
